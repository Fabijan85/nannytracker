<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Noah Hours Tracked - Parent</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
    }
    .container {
      margin-top: 20px;
    }
    .form-section {
      background: #ffffff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .table thead {
      background-color: #343a40;
      color: #fff;
    }
    /* Responsive table wrapper */
    .table-responsive {
      overflow-x: auto;
    }
    /* Summary Statistics Cards */
    .summary-card {
      margin-bottom: 20px;
    }
    /* Login overlay styles */
    #loginOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #loginOverlay .login-box {
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      text-align: center;
      max-width: 300px;
      width: 100%;
    }
  </style>
</head>
<body>
  <!-- Login Overlay for Parent Page -->
  <div id="loginOverlay">
    <div class="login-box">
      <h3>Please Enter Passcode</h3>
      <input type="password" id="parentPasscode" class="form-control" placeholder="Enter passcode" />
      <br />
      <button id="parentLoginBtn" class="btn btn-primary">Login</button>
      <p id="parentLoginError" class="text-danger mt-2" style="display:none;">Incorrect passcode. Please try again.</p>
    </div>
  </div>

  <!-- Main content (hidden until login succeeds) -->
  <div class="container" id="pageContent" style="display:none;">
    <!-- Back to Home Button -->
    <div class="mb-3">
      <a href="index.html" class="btn btn-secondary">Back to Home</a>
    </div>
    <h1>Noah Hours Tracked – Parent View</h1>
    
    <!-- Setup Section -->
    <div class="form-section">
      <h3>Setup</h3>
      <form id="setupForm">
        <div class="mb-3">
          <label for="nannyName" class="form-label">Nanny Name</label>
          <input type="text" class="form-control" id="nannyName" placeholder="Enter nanny's name" required />
        </div>
        <div class="mb-3">
          <label for="hourlyRate" class="form-label">Hourly Rate (£)</label>
          <input type="number" class="form-control" id="hourlyRate" step="0.01" placeholder="Enter hourly rate" required />
        </div>
        <button type="submit" class="btn btn-primary">Save Setup</button>
      </form>
    </div>

    <!-- Summary Statistics Section -->
    <div class="form-section">
      <h3>Summary</h3>
      <div class="row">
        <div class="col-md-6 summary-card">
          <div class="card text-white bg-danger">
            <div class="card-body">
              <h5 class="card-title">Total Unpaid</h5>
              <p class="card-text" id="totalUnpaid">£0.00</p>
            </div>
          </div>
        </div>
        <div class="col-md-6 summary-card">
          <div class="card text-white bg-success">
            <div class="card-body">
              <h5 class="card-title">Total Paid</h5>
              <p class="card-text" id="totalPaid">£0.00</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Entries Table -->
    <div class="form-section">
      <h3>Entries</h3>
      <div class="table-responsive">
        <table class="table table-bordered" id="entriesTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time In</th>
              <th>Time Out</th>
              <th>Hours Worked</th>
              <th>Hourly Rate (£)</th>
              <th>Expenses (£)</th>
              <th>Total Due (£)</th>
              <th>Payment Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Entries will be dynamically inserted here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* === Configuration for Airtable & Zapier === */
    const AIRTABLE_API_KEY = "pat0Rzl5uABgnk8GG.d1bc104ac94080efe34a33578a4ea99e9d24e44837e2b18a5d78cd15fdd9ab70";
    const AIRTABLE_BASE_ID = "appfQoWm5A3bYBamh";
    const SETUP_TABLE = "Setup";
    const ENTRIES_TABLE = "Entries";
    const ZAPIER_WEBHOOK_URL = "https://hooks.zapier.com/hooks/catch/21183830/2fp5klv/";

    // --- Login Functionality for Parent Page ---
    document.getElementById("parentLoginBtn").addEventListener("click", function () {
      const passcode = document.getElementById("parentPasscode").value;
      if (passcode === "Noah0510!") {
        document.getElementById("loginOverlay").style.display = "none";
        document.getElementById("pageContent").style.display = "block";
        sessionStorage.setItem("parentLoggedIn", "true");
      } else {
        document.getElementById("parentLoginError").style.display = "block";
      }
    });
    if (sessionStorage.getItem("parentLoggedIn") === "true") {
      document.getElementById("loginOverlay").style.display = "none";
      document.getElementById("pageContent").style.display = "block";
    }

    let entries = [];
    let currentHourlyRate = null;
    let nannyName = "";

    // Fetch setup data from Airtable.
    function fetchSetup() {
      fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${SETUP_TABLE}`, {
        headers: { "Authorization": "Bearer " + AIRTABLE_API_KEY }
      })
      .then(response => response.json())
      .then(data => {
        if (data.records && data.records.length > 0) {
          const setup = data.records[0].fields;
          nannyName = setup["Nanny Name"] || "";
          currentHourlyRate = setup["Hourly Rate"] ? parseFloat(setup["Hourly Rate"]) : null;
          document.getElementById("nannyName").value = nannyName;
          if (currentHourlyRate !== null) {
            document.getElementById("hourlyRate").value = currentHourlyRate;
          }
        }
      })
      .catch(error => console.error("Error fetching setup:", error));
    }

    // Fetch entries from Airtable.
    function fetchEntries() {
      fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${ENTRIES_TABLE}`, {
        headers: { "Authorization": "Bearer " + AIRTABLE_API_KEY }
      })
      .then(response => response.json())
      .then(data => {
        if (data.records) {
          entries = data.records.map(record => {
            let fields = record.fields;
            return {
              id: record.id,
              date: fields["Date"],
              timeIn: fields["Time In"],
              timeOut: fields["Time Out"],
              hoursWorked: parseFloat(fields["Hours Worked"]),
              entryHourlyRate: parseFloat(fields["Hourly Rate"]),
              expenses: parseFloat(fields["Expenses"]),
              paidStatus: fields["Payment Status"]
            };
          });
          updateEntriesTable();
        }
      })
      .catch(error => console.error("Error fetching entries:", error));
    }

    // Update the entries table.
    function updateEntriesTable() {
      const tbody = document.querySelector("#entriesTable tbody");
      tbody.innerHTML = "";
      entries.forEach((entry) => {
        const totalDue = (entry.hoursWorked * entry.entryHourlyRate) + entry.expenses;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${entry.date}</td>
          <td>${entry.timeIn}</td>
          <td>${entry.timeOut}</td>
          <td>${entry.hoursWorked.toFixed(2)}</td>
          <td>£${entry.entryHourlyRate.toFixed(2)}</td>
          <td>£${entry.expenses.toFixed(2)}</td>
          <td>£${totalDue.toFixed(2)}</td>
          <td>
            <select class="form-select form-select-sm" data-id="${entry.id}" onchange="updatePaymentStatus(this)">
              <option value="Unpaid" ${entry.paidStatus === "Unpaid" ? "selected" : ""}>Unpaid</option>
              <option value="Paid" ${entry.paidStatus === "Paid" ? "selected" : ""}>Paid</option>
            </select>
          </td>
          <td>
            <button class="btn btn-danger btn-sm" onclick="deleteEntry('${entry.id}')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      updateSummaryStats();
    }

    // Update summary statistics.
    function updateSummaryStats() {
      let totalUnpaid = 0;
      let totalPaid = 0;
      entries.forEach(entry => {
        const amount = (entry.hoursWorked * entry.entryHourlyRate) + entry.expenses;
        if (entry.paidStatus === "Paid") {
          totalPaid += amount;
        } else {
          totalUnpaid += amount;
        }
      });
      document.getElementById("totalUnpaid").textContent = "£" + totalUnpaid.toFixed(2);
      document.getElementById("totalPaid").textContent = "£" + totalPaid.toFixed(2);
    }

    // Handle setup form submission via Zapier webhook.
    document.getElementById("setupForm").addEventListener("submit", function (event) {
      event.preventDefault();
      const newNannyName = document.getElementById("nannyName").value;
      const newHourlyRate = parseFloat(document.getElementById("hourlyRate").value);
      const setupData = {
        nannyName: newNannyName,
        hourlyRate: newHourlyRate,
        type: "setupUpdate"
      };
      fetch(ZAPIER_WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(setupData)
      })
      .then(response => {
        console.log("Setup data sent to Zapier.");
        // After a short delay, refresh the setup and entries.
        setTimeout(() => {
          fetchSetup();
          fetchEntries();
        }, 2000);
      })
      .catch(error => console.error("Error sending setup data to Zapier:", error));
    });

    // Update payment status for an entry.
    function updatePaymentStatus(selectElement) {
      const recordId = selectElement.getAttribute("data-id");
      const newStatus = selectElement.value;
      fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${ENTRIES_TABLE}/${recordId}`, {
        method: "PATCH",
        headers: {
          "Authorization": "Bearer " + AIRTABLE_API_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          fields: {
            "Payment Status": newStatus
          }
        })
      })
      .then(response => response.json())
      .then(data => {
        fetchEntries();
      })
      .catch(error => console.error("Error updating payment status:", error));
    }

    // Delete an entry.
    function deleteEntry(recordId) {
      if (confirm("Are you sure you want to delete this entry?")) {
        fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${ENTRIES_TABLE}/${recordId}`, {
          method: "DELETE",
          headers: {
            "Authorization": "Bearer " + AIRTABLE_API_KEY
          }
        })
        .then(response => response.json())
        .then(data => {
          fetchEntries();
        })
        .catch(error => console.error("Error deleting entry:", error));
      }
    }

    window.addEventListener("DOMContentLoaded", function () {
      fetchSetup();
      fetchEntries();
    });
  </script>
</body>
</html>
